#!/usr/bin/env sh
#
# fyr - 2019 (c) MIT | /bin/sh mpvc
# gmt4 - 2022 | fork & contributions
# control mpv remotely using JSON ipc
# https://mpv.io/manual/master/#json-ipc

PROGNAME=$(basename "$0")
PROGVERSION="1.3"
PROGURL="https://github.com/gmt4/mpvc"

usage() {
    cat >&2 << EOF
Usage: $PROGNAME [-S "socket"] [-a "filenames"] [-o "path"] [-f "format string"]
    -p | --toggle       : Toggle playback.
    -s | --stop         : Always stop playback.
    -P | --play         : Always start playback.
    -f | --format       : Enter a formatting string.
    -a | --add          : Add files to playlist from given path (see --load for stdin).
    -i | --playlist     : Print filenames of tracks to fit within terminal.
    -I | --fullplaylist : Print all filenames of tracks in current playlist.
    -o | --save         : Save current playlist to given path.
    -l | --load         : Load playlist from given path (stdin if none is specified).
    -o | --autosave     : Auto save current playlist to ${MPVC_PLAYLIST##$HOME/}.
    -l | --autoload     : Auto load playlist from ${MPVC_PLAYLIST##$HOME/}.
    -l | --lsplaylists  : List playlist from ${MPVC_PLAYLIST##$HOME/}.
    -j | --track        : Go forwards/backwards through the playlist queue.
    -J | --tracknum     : Jump to playlist item number.
    -c | --crop         : Clear the playlist except for the file currently playing.
    -z | --shuffle      : Shuffle the current playlist.
    -l | --loop         : Loop currently playing playlist.
    -L | --loopfile     : Loop currently playing file.
    -v | --vol          : Increase/decrease volume relative to current volume.
    -V | --volume       : Set absolute volume.
    -m | --mute         : Toggle sound.
    -t | --seek         : Increases/decreases time relatively, accepts % values.
    -T | --time         : Set absolute time.
    -x | --speed        : Increase/decrease speed relative to the current speed.
    -X | --speedval     : Set absolute speed.
    -I | --image        : Enable adding of images to the queue.
    -k | --kill         : Kill the mpv process controlling the given socket.
    -K | --killall      : Kill all mpv processes indiscriminately.
    -S | --socket       : Set socket location [default: $MPVC_SOCKET].
    -q | --quiet        : Surpress all text output.
    -Q | --vid=no       : Start mpv with video output disabled.
    -- |                : After adding files options after -- are passed to mpv.
    -h | --help         : Print this help.

    get                 : Get MPV property from $PROGNAME socket.
    set                 : Set MPV property from $PROGNAME socket.
    cmd                 : Send command to $PROGNAME socket.
    sockcmd             : Send MPV JSON IPC command to $PROGNAME socket.
    socklist            : List $PROGNAME sockets.
    togglec             : Toggle MPV cache property.
    togglev             : Toggle MPV video property.
    togglew             : Toggle MPV window property.
    cycle               : Toggle/Cycle through MPV property values.
    idleloop            : Listen to MPV player events on $PROGNAME socket.
    search              : Search the playlist by filename/url.
    searchplay          : Search the playlist by filename and play the first match.
    searchPlay          : Search the playlist by title and play the first match.
    stash               : $PROGNAME stash [list|show|push|drop|apply]
    delay               : Sleep between commands, as in: $PROGNAME play 0 delay seek 20% vol 60

Formatting:
    \`$PROGNAME --format\` will interpret the following delimiters if they are found:

    %name%, %path%, %dir%, %title%, %artist%, %album%, %albumartist%, comment%,
    %genre%, %year%, %percentage%, %playlistlength%, %position%, %repeat%,
    %single, %status%, %time%, %precisetime%, %speed%, %length%, %remaining%,
    %volume%, %muted%, %frame%, %width%, %height%, %ab-loop-a%, %ab-loop-b%

MPC compatibility layer:
    mpvc features a nearly complete compatibility layer for mpc commands in
    addition to GNU style arguments. https://linux.die.net/man/1/mpc

Exit codes:
    0: Program ran succesfully.
    1: Input Argument error.
    2: Socket does not exist.
    3: Socket is not currently open.
    4: Dependency error.
EOF
}

equiet() { "$@" 2> /dev/null; }
oquiet() { "$@" 1> /dev/null; }
quiet()  { "$@" > /dev/null 2>&1; }
quietcheck(){ if [ "$QUIETFLAG" = "true" ]; then quiet "$@"; else "$@"; fi; }

warn()   { echo "$@" >&2; }
eeprintf() { e=$1; shift; warn "$@"; exit "$e"; }

mpvc_defaults()
{
    XDG_CACHE_HOME=${XDG_CACHE_HOME:-"$HOME/.cache"}
    MPVC_CACHE_DIR="${MPVC_CACHE_DIR:-$XDG_CACHE_HOME/mpvc}"

    XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-"$HOME/.config"}
    MPVC_CONFIG_DIR="${MPVC_CONFIG_DIR:-$XDG_CONFIG_HOME/mpvc}"

    MPVC_DATABASE="${MPVC_DATABASE:-$MPVC_CONFIG_DIR/db.m3u}"
    MPVC_PLAYLIST="${MPVC_PLAYLIST:-$MPVC_CONFIG_DIR/playlist}"
    MPVC_CONFIG="${MPVC_CONFIG:-$XDG_CONFIG_HOME/mpvc/mpvc.conf}"
    MPVC_SOCKET="${MPVC_SOCKET:-$MPVC_CONFIG_DIR/mpvsocket0}"
    MPVC_CURL_CACHE="${MPVC_CURL_CACHE:-$MPVC_CONFIG_DIR/curl-cache.txt}"
    MPVOPTIONS="${MPVOPTIONS:---no-audio-display --no-input-terminal}"
    # print default status of mpv instance
    [ -z "$FORMATSTRING" ] && FORMATSTRING="\
%artist% - %title%
[%status%] #%position%/%playlistlength% %time%/%length% (%percentage%%)
speed:%speed%x volume:%volume%% muted:%muted% repeat:%repeat% single:%single%"
    # validate deps
    quiet type mpv || eeprintf 4 "$PROGNAME: Error: No mpv found. Install to continue."
    quiet type socat || type nc || eeprintf 4 "$PROGNAME: Error: No socat/nc found. Install one"
}

# Load user config
mpvc_config()
{
    mpvc_defaults
    # if not present, create config dir
    [ ! -d "$MPVC_CONFIG_DIR" ] && mkdir -p "$MPVC_CONFIG_DIR"
    [ ! -d "$MPVC_CACHE_DIR" ] && mkdir -p "$MPVC_CACHE_DIR"
    [ ! -d "$MPVC_PLAYLIST" ] && mkdir -p "$MPVC_PLAYLIST"
    # if not present, create config files
    touch "$MPVC_CURL_CACHE"
    # if present load user config
    if [ -r "$MPVC_CONFIG" ]; then
        . "$MPVC_CONFIG"
    fi
}

## Retrieval Functions ########################################################

mpvc_curl_cache()
{
    k=$2
    v="$(awk -F'\t' -v k="$k" '{ if ($1 == k) {print $2;exit} }' "$MPVC_CURL_CACHE")"
    if [ -z "$v" ]; then
        v=$(curl "$@")
        echo "$k	$v" >> "$MPVC_CURL_CACHE"
    fi
    echo "$v"
}

# match given filename string to appropriate output
# fn args: filename
cleanFilename() {
    filename="$1"
    result="$1"
    case "$filename" in
        http*.googlevideo.com/*) filename="mps-yt stream" ;;
        http*youtu*|http*watch*) result="$(mpvc_curl_cache -sL "https://youtube.com/oembed?url=$filename" | mpvc_getjson '"title":')" ;;
        *) [ -e "$filename" ] && result=${filename##*/} ;;
    esac
    printf "$result"
}

# fn args: media-title, filename, path
getMediaProperties() {
    mpvc_cmd "get_property" "$1" | escapeChars '[&#]'
}

# fn args: date, genre, title, album, artist, album_artist
getMetadata() {
    cmd="metadata/by-key/$1"
    [ "$1" = "title" ] && cmd=media-title
    metadata=$(mpvc_get "$cmd")
    case "$metadata" in
        '') result="N/A" ;;
        *)  result=$(cleanFilename "$metadata")
    esac
    echo "$result" | escapeChars '[&#]'
}

mpvc_getjson() {
    awk -F ',"' -v jf="$1" '{
        gsub("[{}]", "");
        gsub("\\\\u00", "\\x");
        for (i=1; i<=NF; i++) {
            if ($i ~ jf){ r=$i; sub(jf, "", r); gsub("[\"]", "", r); print r; }
        }
    }'
}

mpvc_sockrepl() { socat - $MPVC_SOCKET || nc -U -N $MPVC_SOCKET; }
mpvc_sockcmd_() { echo "$@" | mpvc_sockrepl; }
mpvc_sockcmd()  { oquiet mpvc_sockcmd_ "$@"; }
mpvc_socklist() {
    for f in $(find "$MPVC_CONFIG_DIR" -type s); do
        idle=$(MPVC_SOCKET=$f mpvc_get idle-active)
        if [ -z "$idle" ]; then
            echo "$f:	active=no";
        else
            echo "$f:	active=yes idle=$idle";
        fi
    done;
}

mpvc_cmd() {
    command=$(for i in "$@"; do printf "\"$i\", "; done)
    equiet mpvc_sockcmd_ "{ \"command\": [ $command ] }" | mpvc_getjson '"data":'
}

mpvc_add()   { mpvc_cmd "add" "$@"; }
mpvc_set()   { mpvc_cmd "set_property" "$@"; }
mpvc_sets()  { mpvc_cmd "set_property_string" "$@"; }

# fn args: mute, pause, loop-file, estimated-frame-number, width, height
mpvc_get() { mpvc_cmd "get_property" "$1"; }

# fn args: filename, idle-active, playlist-count, playlist-pos, playback-time,
#          playtime-remaining, time-remaining, percent-pos, duration, volume
mpvc_gets() {
    result=$(mpvc_cmd "get_property_string" "$1")
    case "$1" in
        volume|duration|percent-pos|playtime-remaining|playback-time)
            result="${result%%%}"
            result="${result%%.[0-9]*}"
        ;;
    esac
    echo "$result"
}

# fn args: speed
getSpeed() { mpvc_gets "speed" | awk '{print substr ($0, 0, 4)}'; }

# fn args: loop-file, loop-playlist
getLoopStatus() {
    status=$(mpvc_get "$1")
    case "$status" in
        true|inf) loop="yes" ;;
        false)    loop="no"  ;;
        *)        loop="N/A" ;;
    esac
    echo "$loop"
}

getPauseStatus() {
    status="$(mpvc_get pause)"
    case "$status" in
        true)  status="paused"  ;;
        false) status="playing" ;;
        *)     status="N/A"     ;;
    esac
    echo "$status"
}

mpvc_get_playlist_once() {
    ctrack=$(mpvc_get playlist-pos)
    mpvc_cmd "get_property_string" "playlist" |
        awk '
        BEGIN { RS="filename\\\\:" }
        {
            gsub("\\\\", ""); sub("(^\\[|]\n|\n|,$)", "");
            sub(",current:true", ""); sub(",playing:true", "");
            if (length($0)>0) print $0
        }' |
        awk -v ctrack="$ctrack" -v numbered="$1" '
        {
            mark=(NR-1 == ctrack)? "*" : " "
            if (length(numbered)>0)
                printf "%2d%s %s\n", NR-1, mark, $0
            else
                print
        }
    '
}

# fn args: $1: filename $2: full path flag to skip basename
mpvc_get_playlist_filename() {
    track="$1"
    fullPath="$2"
    filename=$(mpvc_get "playlist/$track/filename")
    [  "$fullPath" != "fullpath" ] && filename=$(cleanFilename "$filename")
    echo "$filename"
}

# print filenames in current playlist
mpvc_get_playlist() {
    i=0
    mode="$1"
    tracks=$(mpvc_get playlist-count)
    cTrack=$(mpvc_get playlist-pos)

    [ "$mode" = "numbered" ] && mpvc_get_playlist_once $mode && return
    if [ -z "$cTrack" ] || [ -z "$tracks" ] || [ "$tracks" -eq 0 ]; then
        eeprintf 1 "Socket ${MPVC_SOCKET##$HOME/} is currently idle."
    fi
    # by default, display only tracks fitting terminal, otherwise, display all
    FIRST=0
    LAST=$tracks
    [ "$mode" != "full" ] && calculateTerminalHeight "$cTrack" "$tracks"

    mpvc_get_playlist_once |
    while read -r filename;
    do
        if [ $i -ge $FIRST -a $i -lt $LAST ]; then
            filename=$(cleanFilename "$filename")
            case "$i" in
            $cTrack) [ "$COLOURFLAG" != "nocolour" ] && printf '%2d  [7m%s[0m\n' "$i" "$filename";;
            *) printf '%2d  %s\n' "$i" "$filename";;
            esac
        fi
        i=$(( $i + 1 ))
    done
    QUIETFLAG="true"
}

# open mpvc to retrieve all metadata from a playlist file
getFilenameMetadata() {
    trackId="$1"
    isInt "$trackId" || exit 1
    mpvc_get_playlist_filename "$trackId" fullpath
}

# saves playlist to file but with no path checking. we live dangerously
savePlaylist() {
    savePlaylist="$1"
    if [ -z "$savePlaylist" ]; then
        savePlaylist="/dev/stdout"
    else
        if [ -e "$savePlaylist" ]; then
            echo "Playlist $savePlaylist exists! Overwrite? [Y/n] "; read -r key
            [ "$key" != "Y" ] && return
        fi
        echo "Adding files to $savePlaylist ..."
    fi
    mpvc_get_playlist_once > "$savePlaylist"
    QUIETFLAG="true"
}

mpvc_autosave_playlist() {
    savePlaylist "$MPVC_PLAYLIST/${1:-$(date -Imin)}"
}

mpvc_autoload_playlist() {
    loadPlaylist < "$MPVC_PLAYLIST/${1:-$(date -Imin)}"
}

mpvc_lsplaylists() {
    ls -1d "$@" "$MPVC_PLAYLIST"/*
}

# loads a playlist from stdin. Note the buffer trick to avoid clear wiping the playlist.
loadPlaylist() {
    QUIETFLAG="true"
    buffer=""
    while read -r line; do buffer="${buffer}\n${line}"; done
    [ -z "$buffer" ] && return
    [ "$1" = "clear" ] && clearPlaylist
    printf "$buffer\n" | while read -r line; do mpvc_appendtracks "$line"; done
}

# mpvc stash [list|show|push|drop|apply]
mpvc_stash() {
    cmd="$1"; shift

    QUIETFLAG="true"
    MPVC_STASH_DIR="${MPVC_STASH_DIR:-$MPVC_CONFIG_DIR/stash}"
    mkdir -p $MPVC_STASH_DIR
    case "$cmd" in
        list) ls -ltr $MPVC_STASH_DIR ;;
        show) cat "$MPVC_STASH_DIR/$1" ;;
        drop) rm -i "$MPVC_STASH_DIR/$1" ;;
        push)
            [ -e "$MPVC_STASH_DIR/$1" ] && exit
            mpvc_stash current > "$MPVC_STASH_DIR/$1"
            ;;
        apply)
            while read -r line
            do
                case "$line" in
                    "# $PROGNAME "*) echo "$line";;
                    "mpvc cmd "*) $line;;
                    "mpvc sets "*) $line;;
                    "mpvc add "*) mpvc add "${line##mpvc add }";;
                esac
            done < "$MPVC_STASH_DIR/$1"
            ;;
        current)
            echo "# $PROGNAME stash $MPVC_STASH_DIR/$1 # $PROGURL @version $PROGVERSION"
            echo "mpvc sets pause yes"
            echo "mpvc cmd playlist-clear"
            echo "mpvc cmd playlist-remove 0"
            mpvc_get_playlist_once | awk '{ print "mpvc add "$0 }'
            echo "mpvc sets playlist-pos $(mpvc_gets playlist-pos)"
            echo "mpvc sets playback-time $(mpvc_gets playback-time)"
            echo "mpvc sets loop-file $(mpvc_gets loop-file)"
            echo "mpvc sets loop-playlist $(mpvc_gets loop-playlist)"
            echo "mpvc sets ab-loop-a $(mpvc_get ab-loop-a)"
            echo "mpvc sets ab-loop-b $(mpvc_get ab-loop-b)"
            echo "mpvc sets idle $(mpvc_gets idle)"
            echo "mpvc sets mute $(mpvc_gets mute)"
            echo "mpvc sets video $(mpvc_gets video)"
            echo "mpvc sets video-zoom $(mpvc_gets video-zoom)"
            echo "mpvc sets fullscreen $(mpvc_gets fullscreen)"
            echo "mpvc sets cache $(mpvc_gets cache)"
            echo "mpvc sets speed $(mpvc_gets speed)"
            echo "mpvc sets volume $(mpvc_gets volume)"
            echo "mpvc sets volume-max $(mpvc_gets volume-max)"
            echo "mpvc sets pause $(mpvc_gets pause)"
            #echo "mpvc sets af $(mpvc_gets af)"
            #echo "mpvc sets working-directory $(mpvc_gets working-directory)"
            ;;
        *)
            warn "$PROGNAME stash: error: unknown subcommand $cmd."
            ;;
    esac
}

mpvc_dbinit() {
    locate -b '*.mp3' '*.mp4' '*.ogg' '*.opus' |
        sed 's|^\(/.*/\).*|\1|' | sort | uniq |
        tee "$MPVC_DATABASE"
}

mpvc_dblist() {
    cat "$MPVC_DATABASE"
    for playlist in $(printf "%s\n" $MPVC_PLAYLIST/*); do echo $playlist; done
}

## Control Functions ##########################################################

mpvc_appendtrack() {
    filename="$*"
    # require absolute paths
    case "$filename" in
        /*) ;; *) [ -e "$filename" ] && filename="$(pwd)/$filename" ;;
    esac
    # skip over various other filetypes and images unless wanted
    case "$filename" in
        *.txt|*.log|*.cue) return ;;
        *.png|*.jpg|*.jpeg|*.gif|*.psd|*.pdf) [ "$IMAGEFLAG" != "true" ] && return ;;
        http*) ;;
    esac
    if [ -n "$filename" ]; then
        quiet mpvc_cmd "loadfile" "$filename" "append-play"
        echo "Adding: $(cleanFilename "$filename")"
    fi
}

mpvc_appendtracks() {
    shiftcount=0
    QUIETFLAG="true"
    if [ -z "$(mpvc_get idle-active)" ]; then
        echo "$PROGNAME: No running mpv found, starting mpv now"
        mpvc_startmpv --really-quiet --idle=once
    fi
    for arg in "$@"; do
        case "$arg" in
        http*) mpvc_appendtrack "$arg"; _=$((shiftcount+=1)) ;;
        *)     if [ -e "$arg" ]; then mpvc_appendtrack "$arg"; _=$((shiftcount+=1)); fi
        esac
    done
    return $shiftcount
}

playNext() {
    QUIETFLAG="true"
    # add track to the playlist
    mpvc_appendtracks "$1"
    # find position of track to move
    trackToMove="$(( $(mpvc_get playlist-count) - 1 ))"
    # find position of current track
    newTrackPosition="$(( $(mpvc_get playlist-pos) + 1 ))"
    # set position of next track
    moveTrack "$trackToMove" "$newTrackPosition"
}

setTime() {
    mode=$1; shift
    if [ "$mode" = "absolute" ]; then
        timeSec=$(parseTimeString "$1") || return $?
        mpvc_sets "playback-time" "$timeSec"
        return
    fi
    # relative
    case "$1" in
        *%*) mpvc_sets "percent-pos" "${1%%%}"; return ;;
        -*)  mpvc_add "playback-time" "-$(parseTimeString "${1##-}")" ;;
        +*)  mpvc_add "playback-time" "+$(parseTimeString "${1##+}")" ;;
        *)   mpvc_add "playback-time" "$(parseTimeString "${1}")" ;;
    esac
}

setTrack() {
    isInt "$1" || return 1
    cTrack=$(mpvc_get playlist-pos)
    trackCount=$(mpvc_get playlist-count)
    [ "$cTrack" = "null" ] && cTrack=0
    case "$2" in
        absolute) newTrack=$1 ;;
        relative)
            newTrack=$((cTrack + $1))
            # if time is greater than 10 seconds, set time to 0
            if [ "$newTrack" -lt "$cTrack" ]; then
                seconds=$(mpvc_gets playback-time)
                [ "$seconds" -ge 10 ] && setTime "absolute" 0 && return
            fi
            if [ "$newTrack" -ge "$trackCount" ]; then
                [ "$(getLoopStatus loop-playlist)" = "yes" ] && newTrack=0
            fi
            if [ "$newTrack" -lt 0 ]; then
                newTrack=0
                [ "$(getLoopStatus loop-file)" = "yes" ] && newTrack=$trackCount
            fi
        ;;
    esac
    if [ "$newTrack" -lt 0 ] || [ "$newTrack" -ge "$trackCount" ]; then
        eeprintf 1 "Item $newTrack is out of range of playlist."
    fi
    quiet mpvc_set "playlist-pos" "$newTrack"
}

moveTrack() {
    isInt "$1" || exit 1
    QUIETFLAG="true"
    if [ -z "$2" ]; then
        trackToMove=$(mpvc_get playlist-pos)
        newTrackPosition=$1
    else
        trackToMove=$1
        trackCount=$(mpvc_get playlist-count)
        [ "$1" = "$" ] && trackToMove="$trackCount"
        newTrackPosition=$2
        [ "$2" = "$" ] && newTrackPosition="$trackCount"
        if [ "$trackToMove" -lt 0 ] || [ "$trackToMove" -gt "$trackCount" ]; then
            eeprintf 1 "Item $trackToMove is out of range of playlist."
        fi
    fi

    [ "$newTrackPosition" -lt 0 ] &&
        eeprintf 1 "Position $newTrackPosition is out of range of playlist."
    #[ "$newTrackPosition" -eq 1 ] && newTrackPosition=0
    quiet mpvc_cmd "playlist-move" "$trackToMove" "$newTrackPosition"

    quietcheck mpvc_get_playlist
}

removeTrack() {
    trackId=$1
    if [ "$trackId" = "current" ]; then
        oquiet mpvc_cmd "playlist-remove" "$trackId"
        return;
    fi
    isInt "$trackId" || return 1
    trackCount=$(mpvc_get playlist-count)
    if [ -z "$trackCount" ] || [ "$trackId" -lt 0 ] || [ "$trackId" -ge "$trackCount" ]; then
        warn "Item $trackId is out of range of playlist."
    fi
    filename="$(mpvc_get_playlist_filename "$trackId")"
    oquiet mpvc_cmd "playlist-remove" "$trackId"
    quietcheck warn "$filename has been removed from the playlist."
}

mpvc_always_play() {
    if [ "$(mpvc_get playlist-pos)" = "null" ]; then
        setTrack 0 absolute; return
    fi
    mpvc_set_pause "no"
}

mpvc_set_pause() {
    quiet mpvc_set "pause" "$1"
}

mpvc_toggle_pause() {
    quiet mpvc_cmd "cycle" "pause"
}

mpvc_toggle_cache() {
    quiet mpvc_cmd "cycle" "cache"
}

mpvc_toggle_video() {
    quiet mpvc_cmd "cycle" "video"
}

mpvc_toggle_window() {
    quiet mpvc_cmd "cycle" "force-window"
}

mpvc_toggle_mute() {
    [ -n "$1" ] && quiet mpvc_sets "mute" "$1" && return
    quiet mpvc_cmd "cycle" "mute"
}

mpvc_set_volume() {
    case "$1" in
        '') eeprintf 1 "Specify volume in/decrease amount or absolute amount." ;;
        +*) mpvc_add "volume" "$1"  ;;
        -*) mpvc_add "volume" "$1"  ;;
        *%) mpvc_set "volume" "$1%" ;;
        *)  mpvc_set "volume" "$1" ;;
    esac
}

mpvc_toggle_loopfile() {
    case "$1" in
        '')      quiet mpvc_cmd "cycle-values" "loop-file" "yes" "no" ;;
        on|yes)  quiet mpvc_sets "loop-file" yes ;;
        off|no)  quiet mpvc_sets "loop-file" no  ;;
    esac
}

mpvc_toggle_loopplaylist() {
    case "$1" in
        '')      quiet mpvc_cmd "cycle-values" "loop-playlist" "yes" "no" ;;
        on|yes)  quiet mpvc_sets "loop-playlist" "inf" ;;
        off|no)  quiet mpvc_sets "loop-playlist" "no"  ;;
    esac
}

mpvc_search_play() {
    mode=$1; shift
    [ -z "$1" ] && return
    track=$(
        mpvc_get_playlist "$mode" | awk '/'"$@"'/ { sub("\\*",""); print $1; exit; }'
    )
    [ -z "$track" ] && eeprintf 1 "$PROGNAME: Searching for $*, nothing found."
    setTrack "$track" absolute
}

mpvc_search_remove() {
    tracks=$(mpvc_get_playlist "numbered" |tac| awk '/'"$1"'/ { sub("\\*",""); print $1 } ')
    for i in $tracks; do removeTrack "$i"; done
    QUIETFLAG=true
}

mpvc_search_move() {
    tracks=$(mpvc_get_playlist "numbered" |tac| awk '/'"$1"'/ { sub("\\*",""); print $1 } ')
    for i in $tracks; do moveTrack "$i" "$2"; done
    QUIETFLAG=true
}

mpvc_shuffle_playlist() {
    case "$1" in
        shuffle) quiet mpvc_cmd "playlist-shuffle";;
        unshuffle) quiet mpvc_cmd "playlist-shuffle";;
        *) return;;
    esac
    echo "Playlist $1."
    [ "$(getLoopStatus loop-playlist)" != "yes" ] && toggleLoopPlaylist inf
}

cropPlaylist() {
    quiet mpvc_cmd "playlist-clear"
    quietcheck mpvc_get_playlist
}

clearPlaylist() {
    # kill any running process of mpvc add
    #quiet pgrep -f "mpvc add" && pkill -f "mpvc add"
    cropPlaylist
    removeTrack 0
    echo "Playlist cleared."
}

## Time Functions #############################################################

getTrackLength() { formatTime "$(mpvc_gets duration)"; }
playtimeRemaining() { formatTime "$(mpvc_gets playtime-remaining)"; }
getElapsedTime() { formatTime "$(mpvc_gets playback-time)"; }

getElapsedTimePrecise() {
    time=$(mpvc_gets playback-time 0.0)
    formatTime "${time%%.*}" "${time#*.}"
}

# format seconds into HH:MM:SS format
formatTime() {
    [  "$1" = "null" ] && return 1
    rawSeconds=$1
    milleSeconds=$2
    seconds=$((rawSeconds % 60))
    minutes=$((rawSeconds / 60))
    hours=$((minutes / 60))
    minutes=$((minutes - hours*60))
    if [ -z "$milleSeconds" ]; then
        printf "%02d:%02d:%02d" "$hours" "$minutes" "$seconds"
    else
        printf "%02d:%02d:%02d.%d" "$hours" "$minutes" "$seconds" "$milleSeconds"
    fi
}

## Formatting and Printing Functions ##########################################

# formats and prints according to $FORMATSTRING
formatPrint() {
    # modified format string
    F="$FORMATSTRING"
    # not that nice, in fact, way more ugly, but too way faster
    for f in $(echo "$F" | sed 's#[;/]# #g')
    do
        case $f in
        (*%status%*) F=$(echo "$F" | sed "s#%status%#$(getPauseStatus)#g") ;;
        (*%year%*) F=$(echo "$F" | sed "s#%year%#$(getMetadata date)#g") ;;
        (*%genre%*) F=$(echo "$F" | sed "s#%genre%#$(getMetadata genre)#g") ;;
        (*%title%*) F=$(echo "$F" | sed "s#%title%#$(getMetadata title)#g") ;;
        (*%album%*) F=$(echo "$F" | sed "s#%album%#$(getMetadata album)#g") ;;
        (*%artist%*) F=$(echo "$F" | sed "s#%artist%#$(getMetadata artist)#g") ;;
        (*%comment%*) F=$(echo "$F" | sed "s#%comment%#$(getMetadata comment)#g") ;;
        (*%albumartist%*) F=$(echo "$F" | sed "s#%albumartist%#$(getMetadata album_artist)#g") ;;
        (*%speed%*) F=$(echo "$F" | sed "s#%speed%#$(getSpeed)#g") ;;
        (*%time%*) F=$(echo "$F" | sed "s#%time%#$(getElapsedTime)#g") ;;
        (*%precisetime%*) F=$(echo "$F" | sed "s#%precisetime%#$(getElapsedTimePrecise)#g") ;;
        (*%playback-time%*) F=$(echo "$F" | sed "s#%playback-time%#$(mpvc_get playback-time)#g") ;;
        (*%volume%*) F=$(echo "$F" | sed "s#%volume%#$(mpvc_gets volume)#g") ;;
        (*%length%*) F=$(echo "$F" | sed "s#%length%#$(getTrackLength)#g") ;;
        (*%remaining%*) F=$(echo "$F" | sed "s#%remaining%#$(playtimeRemaining)#g") ;;
        (*%muted%*) F=$(echo "$F" | sed "s#%muted%#$(mpvc_gets mute)#g") ;;
        (*%percentage%*) F=$(echo "$F" | sed "s#%percentage%#$(mpvc_gets percent-pos)#g") ;;
        (*%name%*) F=$(echo "$F" | sed "s#%name%#$(getMediaProperties filename)#g") ;;
        (*%path%*) F=$(echo "$F" | sed "s#%path%#$(getMediaProperties path)#g") ;;
        (*%dir%*) F=$(echo "$F" | sed "s#%dir%#$(mpvc_gets working-directory)#g") ;;
        (*%repeat%*) F=$(echo "$F" | sed "s#%repeat%#$(mpvc_gets loop-playlist)#g") ;;
        (*%single%*) F=$(echo "$F" | sed "s#%single%#$(mpvc_gets loop-file)#g") ;;
        (*%playlistlength%*) F=$(echo "$F" | sed "s#%playlistlength%#$(mpvc_get playlist-count)#g") ;;
        (*%position%*) F=$(echo "$F" | sed "s#%position%#$(($(mpvc_get playlist-pos) + 1))#g") ;;
        (*%frame%*) F=$(echo "$F" | sed "s#%frame%#$(mpvc_get estimated-frame-number)#g") ;;
        (*%width%*) F=$(echo "$F" | sed "s#%width%#$(mpvc_get width)#g") ;;
        (*%height%*) F=$(echo "$F" | sed "s#%height%#$(mpvc_get height)#g") ;;
        (*%ab-loop-a%*) F=$(echo "$F" | sed "s#%ab-loop-a%#$(mpvc_get ab-loop-a)#g") ;;
        (*%ab-loop-b%*) F=$(echo "$F" | sed "s#%ab-loop-b%#$(mpvc_get ab-loop-b)#g") ;;
        esac
    done
    echo "${F}"
}

printFinalOutput() {
    [ "$QUIETFLAG" = "true" ] && return
    # catches if mpv is idle or not
    if [ "$(mpvc_get idle-active)" = "yes" ]; then
        warn "MPV on ${MPVC_SOCKET##$HOME/} is currently idle."; return
    fi
    formatPrint
}

## Misc Functions #############################################################

escapeChars() { awk -v r="$1" '{ gsub(r, "\\\\&"); print $0; }'; }
isInt() { printf '%d' "$1" >/dev/null; }
isFloat() { [ -z "${1##*.*}" ] && printf '%f' "$1" >/dev/null; }

calculateTerminalHeight() {
    ctrack="$1"
    tracks="$2"
    lines=$(tput lines)
    crow=${MPVC_CLINE:-3}
    rows=$((lines - crow))
    halfrows=$((rows / 2))
    [ "$ctrack" = "null" ] && ctrack=0
    if [ "$tracks" -le $rows ]; then
        FIRST=0; LAST=$tracks
    elif [ "$ctrack" -le $halfrows ]; then
        FIRST=0; LAST=$rows
    elif [  $((ctrack + halfrows)) -ge "$tracks" ]; then
        FIRST=$((tracks - rows)); LAST=$tracks
    elif [  $((ctrack + halfrows)) -lt "$tracks" ]; then
        FIRST=$((ctrack - halfrows)); LAST=$((ctrack + halfrows))
    fi
}

parseTimeString() {
    if ! echo "$1" | grep -q -e "^\([0-9.]*:\)\{0,2\}[0-9.]*$" -e "^[0-9]*[sSmMhH]$"; then
        warn "Timestamp formats must match either H:M:S with hour and minute fields optional,"
        warn "or a single integer number with a unit of time appended: h, m, s."
        exit 1
    fi
    case "$1" in
        *s|*S|*m|*M|*h|*H)
            timeInt=${1%%?}
            isInt "$timeInt" || exit 1
            case "$1" in
                *h|*H) timeInt=$((timeInt * 60 * 60)) ;;
                *m|*M) timeInt=$((timeInt * 60))      ;;
            esac
            ;;
        *)
            timeInt=$(printf '%s' "$1" |
                awk -F ':' '{ for (x=1; x<=NF; x++) t=t*60+$x; print t }')
            ;;
    esac
    printf "%d" "$timeInt"
}

mpvc_validate_socket() {
    # test if socket exists
    [ ! -S "$MPVC_SOCKET" ] && eeprintf 2 "Socket ${MPVC_SOCKET##$HOME/} does not exist. Use mpvc --mpv to start one."
    # test if socket is open
    [ "$(getPauseStatus)" = "N/A" ] && eeprintf 3 "No files added to ${MPVC_SOCKET##$HOME/}."
}

mpvc_get_version() {
    mpv --version
    echo "MPVC Release $PROGVERSION (c) Laurence Willetts MIT"
}

mpvc_idleloop() {
    mpvc_cmd "unobserve_property" 1
    mpvc_cmd "observe_property" 1 "$@"
    socat -t0 -,ignoreeof "$MPVC_SOCKET"
}

mpvc_delay() { sleep ${1:-0.1}; }
# mpvc_startmpv: exec & wait until mpv starts up
mpvc_startmpv() {
    exec mpv --input-ipc-server="$MPVC_SOCKET" $MPVOPTIONS "$@" &
    until [ -n "$(mpvc_get idle-active)" ]; do mpvc_delay 0.1; done
}

main() {
    mpvc_config
    case "$1" in
    -k|--kill|kill|-K|--killall|killall) ;;
    -c|--crop|crop|-C|--clear|clear|cmd|sockcmd|socklist|--socklist) ;;
    -a|add|append|-A|playnext|--playnext|mpv|--mpv|stash|--stash|--toggle|toggle|-q|--quiet) ;;
    load|--load|autoload|--autoload|lsplaylists|--lsplaylists|dbinit|--dbinit|dblist|--dblist) ;;
    version|--version|help|--help|-h|--list-options|-Q|--vid=no|-S) ;;
    *) mpvc_validate_socket;; # otherwise, validate socket
    esac
    for arg in "$@"; do
        # grab mpv options first if any
        [ "$arg" = "--" ] && { MPVFLAG=true; shift; continue; }
        [ "$MPVFLAG" = "true" ] && { MPVOPTIONS="$MPVOPTIONS $arg"; shift; continue; }
        case "$1" in
            # mpc compatibility layer
            play|start|resume)
                shift
                case "$1" in
                    '') ;;
                    $) setTrack "$(( $(mpvc_get playlist-count) - 1 ))" absolute;;
                    *) isInt "$1" && setTrack "$1" absolute;;
                esac
                mpvc_always_play
            ;;
            vol|volume) shift; mpvc_set_volume "$1" ;;
            repeat)     shift; mpvc_toggle_loopplaylist "$1" ;;
            single)     shift; mpvc_toggle_loopfile "$1" ;;
            metadata)   shift; getFilenameMetadata "$1" ;;
            pause)      mpvc_set_pause "yes"       ;;
            next)       setTrack 1 relative ;;
            prev)       setTrack -1 relative;;
            move|mv)    shift; moveTrack "$1" "$2" ;;
            mute)       mpvc_toggle_mute yes     ;;
            unmute)     mpvc_toggle_mute no      ;;
            pretty)     eeprintf 1 "$PROGNAME: $* not implemented" ;;
            find)       eeprintf 1 "$PROGNAME: $* not implemented" ;;

            add|-a|--append) mpvc_appendtracks "$@"; shift "$((shiftcount+1))" ;;
            #replace|--replace) replaceTracks "$@"; shift "$((shiftcount+1))" ;;
            mpv|--mpv)
                shift; QUIETFLAG=true
                if ! pgrep -f "mpv .*$MPVC_SOCKET .*--idle=yes"; then
                    mpvc_startmpv --really-quiet --idle=yes "$@";
                fi
                break
                ;;
            # consume) to implement # add on|off toggle
            # random) MPV doesn't have this control option!

            # GNU-style options
            -t|--seek|seek)                  shift; setTime "relative" "$1" ;;
            -T|--time|time)                  shift; setTime "absolute" "$1" ;;
            -v|--vol)                        shift; mpvc_add "volume" "$1"  ;;
            -V|--volume)                     shift; mpvc_set "volume" "$1"  ;;
            -x|--speed|speed)                shift; mpvc_add  "speed" "$1"  ;;
            -X|--speedval)                   shift; mpvc_sets "speed" "$1"  ;;
            -j|--track)                      shift; setTrack "$1" relative  ;;
            -J|--tracknum)                   shift; setTrack "$1" absolute  ;;
            -r|--remove|rm|remove|del)       shift; removeTrack "$1"; QUIETFLAG=true;;
            -A|--playnext|playnext)          shift; playNext "$1"           ;;
            -o|--save|save)                  shift; savePlaylist "$1"       ;;
            --load|load)                     shift; loadPlaylist            ;;

            --current|current)               ;;
            --loadc|loadc)                   shift; loadPlaylist "clear"    ;;
            --saven|saven)                   shift; mpvc_get_playlist_once "numbered"; QUIETFLAG=true;;
            --autosave|autosave)             shift; mpvc_autosave_playlist "$1"; ;;
            --autoload|autoload)             shift; mpvc_autoload_playlist "$1"; ;;
            --lsplaylists|lsplaylists)       shift; mpvc_lsplaylists "$1"; QUIETFLAG=true;;
            --dblist|dblist)                 shift; mpvc_dblist; return          ;;
            --dbinit|dbinit)                 shift; mpvc_dbinit; return          ;;
            --cycle|cycle)                   shift; mpvc_cmd cycle "$@"; QUIETFLAG=true;;
            --set|set|s)                     shift; mpvc_cmd set_property "$@"; return;;
            --get|get|g)                     shift; mpvc_cmd get_property "$1"; QUIETFLAG=true;;
            --sets|sets|ss)                  shift; mpvc_cmd set_property_string "$@"; return;;
            --gets|gets|gs)                  shift; mpvc_cmd get_property_string "$1"; QUIETFLAG=true;;
            --togglec|togglec)               shift; mpvc_toggle_cache ;;
            --togglev|togglev)               shift; mpvc_toggle_video ;;
            --togglew|togglew)               shift; mpvc_toggle_window ;;
            --idleloop|idleloop)             shift; mpvc_idleloop "$1"; QUIETFLAG=true ;;
            --cmd|cmd)                       shift; mpvc_cmd "$@"; return ;;
            --sockcmd|sockcmd)               shift; mpvc_sockcmd "$1"; QUIETFLAG=true ;;
            --sockrepl|sockrepl)             shift; mpvc_sockrepl; QUIETFLAG=true ;;
            --socklist|socklist)             shift; mpvc_socklist "$1"; QUIETFLAG=true ;;
            --search|search)                 shift; mpvc saven | awk '/'"$@"'/'; QUIETFLAG=true ;;
            -R|--searchrm|searchrm)          shift; mpvc_search_remove "$1";;
            -M|--searchmv|searchmv)          shift; mpvc_search_move "$1" "$2";;
            -n|--searchplay|searchplay)      shift; mpvc_search_play "numbered" "$1" ;;
            -N|--searchPlay|searchPlay)      shift; mpvc_search_play "full" "$1" ;;
            --stash|stash)                   shift; mpvc_stash "$1" "$2";;

            -k|--kill|kill)                  quiet mpvc_cmd "quit"; QUIETFLAG=true ;;
            -K|--killall|killall)            quiet pkill -f "mpv "; QUIETFLAG=true ;;
            -s|--stop|stop)                  mpvc_set_pause "yes"; setTime "absolute" 0 ;;
            -P|--play)                       mpvc_always_play ;;
            -p|--toggle|toggle)              mpvc_toggle_pause;;
            -m|--mute)                       mpvc_toggle_mute               ;;
            -i|--playlist|playlist)          mpvc_get_playlist "";          ;;
            -I|--fullplaylist|fullplaylist)  mpvc_get_playlist "full";      ;;
            -L|--loop|loop)                  mpvc_toggle_loopplaylist       ;;
            -l|--loopfile|loopfile)          mpvc_toggle_loopfile           ;;
            -z|--shuffle|shuffle)            mpvc_shuffle_playlist shuffle; QUIETFLAG=true;;
            -Z|--unshuffle|unshuffle)        mpvc_shuffle_playlist unshuffle; QUIETFLAG=true;;
            -c|--crop|crop)                  cropPlaylist; QUIETFLAG=true;;
            -C|--clear|clear)                clearPlaylist; QUIETFLAG=true;;
            --delay|delay)                   mpvc_delay;;

            # global argument parsing
            -f|--format)                     shift; FORMATSTRING="$1"       ;;
            -S|--socket)                     shift; MPVC_SOCKET="$1"; mpvc_config ;;
            -Q|--vid=no)                     MPVOPTIONS="$MPVOPTIONS --vid=no"; ;;
            --image)                         IMAGEFLAG=true;                ;;
            -q|--quiet)                      QUIETFLAG=true;                ;;
            --mono|mono)                     COLOURFLAG=nocolour;           ;;
            --colour|colour)                 COLOURFLAG=colour;             ;;
            --version|version)               mpvc_get_version;              ;;
            --list-options)                  usage; exit 0;                 ;;
            -h|--help|h|help)                usage; exit 0;                 ;;
            -?)                              usage; exit 1;                 ;;
        esac
        [ -n "$1" ] && shift
    done
    # produce format strings last
    quietcheck printFinalOutput
}

quietcheck main "$@";
